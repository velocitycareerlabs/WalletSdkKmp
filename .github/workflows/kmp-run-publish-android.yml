name: KMP RUN Publish Android

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - rc
          - prod

env:
  JAVA_VERSION: "17"

permissions:
  contents: write
  packages: write

jobs:
  release-android-sdk:
    runs-on: macos-15

    steps:
      - name: ðŸ§¾ Checkout code
        uses: actions/checkout@v4

      - name: â˜• Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      - name: ðŸ› ï¸ Set up Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      # - name: ðŸ“ Get version from build.gradle
      #   run: |
      #     VERSION=$(grep 'publishVersion *= *".*"' velocityexchangeverifiers/build.gradle | sed -n 's/.*publishVersion *= *"\([^"]*\)".*/\1/p')
      #     echo "RELEASE_VERSION=$VERSION" >> $GITHUB_ENV
      #     echo "Found version: $VERSION"

      - name: ðŸ“ Get version from gradle.properties
        shell: bash
        run: |
          set -euo pipefail
          VERSION=$(grep '^PUBLISH_VERSION=' gradle.properties | cut -d'=' -f2 | tr -d '[:space:]')
          if [ -z "$VERSION" ]; then echo "PUBLISH_VERSION missing in gradle.properties"; exit 1; fi
          echo "RELEASE_VERSION=$VERSION" >> $GITHUB_ENV
          echo "Found version: $VERSION"

      - name: ðŸ”§ Set publication name and POM file name
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ github.event.inputs.environment }}" = "rc" ]; then
            echo "PUBLICATION_NAME=rc" >> $GITHUB_ENV
            echo "EFFECTIVE_VERSION=${RELEASE_VERSION}-rc" >> $GITHUB_ENV
          else
            echo "PUBLICATION_NAME=release" >> $GITHUB_ENV
            echo "EFFECTIVE_VERSION=${RELEASE_VERSION}" >> $GITHUB_ENV
          fi
          echo "POM_FILE_NAME=velocityexchangeverifiers-${EFFECTIVE_VERSION}.pom" >> $GITHUB_ENV

      - name: ðŸ§ª Build AAR + Sources + Javadoc
        shell: bash
        run: |
          set -euo pipefail
            ./gradlew :velocityexchangeverifiers:clean \
            :velocityexchangeverifiers:assembleAndroid \
            -PprojectVersion=${RELEASE_VERSION} \
            -Pprerelease=${{ github.event.inputs.environment == 'rc' }} \
            --stacktrace

      - name: âœ… Verify expected artifacts exist
        run: |
          ./gradlew :velocityexchangeverifiers:verifyExpectedArtifactsExist

      - name: ðŸ§¹ Clean staging root
        shell: bash
        run: |
          set -euo pipefail
          rm -rf velocityexchangeverifiers/target/staging-deploy/io/velocitycareerlabs/velocityexchangeverifiers
          mkdir -p velocityexchangeverifiers/target/staging-deploy/io/velocitycareerlabs/velocityexchangeverifiers

      - name: ðŸ“¦ Stage Artifacts
        run: |
          ./gradlew :velocityexchangeverifiers:stageArtifacts

      - name: ðŸ§ª Generate POM File
        shell: bash
        run: |
          set -euo pipefail
          ./gradlew :velocityexchangeverifiers:generatePomFileFor${{ env.PUBLICATION_NAME }}Publication \
            -PprojectVersion=${RELEASE_VERSION} -Pprerelease=${{ github.event.inputs.environment == 'rc' }}
          mkdir -p velocityexchangeverifiers/target/staging-deploy/io/velocitycareerlabs/velocityexchangeverifiers/${{ env.EFFECTIVE_VERSION }}
          cp velocityexchangeverifiers/build/publications/${{ env.PUBLICATION_NAME }}/pom-default.xml \
             velocityexchangeverifiers/target/staging-deploy/io/velocitycareerlabs/velocityexchangeverifiers/${{ env.EFFECTIVE_VERSION }}/${{ env.POM_FILE_NAME }}

      - name: ðŸ“‚ List staged artifacts
        run: |
          ls -R velocityexchangeverifiers/target/staging-deploy

      - name: ðŸ”’ Guard staged contents
        shell: bash
        run: |
          set -euo pipefail
          BASE=velocityexchangeverifiers/target/staging-deploy/io/velocitycareerlabs/velocityexchangeverifiers
          echo "Contents of $BASE:"
          ls -1 "$BASE" || true
          for d in "$BASE"/*; do
            [ -d "$d" ] || continue
            bn=$(basename "$d")
            if [ "$bn" != "${EFFECTIVE_VERSION}" ]; then
              echo "Unexpected version dir present: $bn"
              exit 1
            fi
          done
          ls -1 "$BASE/${EFFECTIVE_VERSION}"

      - name: ðŸ”Ž Verify POM version matches EFFECTIVE_VERSION
        shell: bash
        run: |
          set -euo pipefail
          POM=velocityexchangeverifiers/target/staging-deploy/io/velocitycareerlabs/velocityexchangeverifiers/${EFFECTIVE_VERSION}/velocityexchangeverifiers-${EFFECTIVE_VERSION}.pom
          grep -q "<version>${EFFECTIVE_VERSION}</version>" "$POM" || { echo "POM version mismatch"; exit 1; }

      - name: ðŸ“œ Show staged file names
        shell: bash
        run: |
          set -euo pipefail
          dir=velocityexchangeverifiers/target/staging-deploy/io/velocitycareerlabs/velocityexchangeverifiers/${EFFECTIVE_VERSION}
          ls -l "$dir"

      - name: Validate staged files
        shell: bash
        run: |
          set -euo pipefail
          dir=velocityexchangeverifiers/target/staging-deploy/io/velocitycareerlabs/velocityexchangeverifiers/${EFFECTIVE_VERSION}
          test -f "$dir/velocityexchangeverifiers-${EFFECTIVE_VERSION}.pom"
          test -f "$dir/velocityexchangeverifiers-${EFFECTIVE_VERSION}.aar"
          test -f "$dir/velocityexchangeverifiers-${EFFECTIVE_VERSION}-sources.jar"
          test -f "$dir/velocityexchangeverifiers-${EFFECTIVE_VERSION}-javadoc.jar"

      - name: ðŸš€ Run JReleaser full-release
        uses: jreleaser/release-action@v2
        with:
          version: 1.18.0
          arguments: >
            full-release
            --config-file=jreleaser.template.yml
            --debug
        env:
          JRELEASER_PROJECT_JAVA_ARTIFACT_ID: ${{ 'velocityexchangeverifiers' }}
          JRELEASER_MAVENCENTRAL_USERNAME: ${{ secrets.MAVEN_CENTRAL_TOKEN_USERNAME }}
          JRELEASER_MAVENCENTRAL_PASSWORD: ${{ secrets.MAVEN_CENTRAL_TOKEN_PASSWORD }}
          JRELEASER_MAVENCENTRAL_STAGE: ${{ secrets.MAVEN_CENTRAL_STAGING_PROFILE_ID }}
          JRELEASER_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          JRELEASER_PROJECT_VERSION: ${{ env.EFFECTIVE_VERSION }}
          JRELEASER_GPG_PUBLIC_KEY: ${{ secrets.MAVEN_CENTRAL_GPG_PUBLIC_KEY }}
          JRELEASER_GPG_SECRET_KEY: ${{ secrets.MAVEN_CENTRAL_GPG_PRIVATE_KEY }}
          JRELEASER_GPG_PASSPHRASE: ${{ secrets.MAVEN_CENTRAL_SIGNING_PASSWORD }}
          JRELEASER_TAG_NAME: ${{ env.EFFECTIVE_VERSION }}
          JRELEASER_RELEASE_NAME: ${{ github.event.inputs.environment == 'rc' && 'Release Candidate ' || '' }}${{ env.EFFECTIVE_VERSION }}
          JRELEASER_PRERELEASE_PATTERN: ${{ github.event.inputs.environment == 'rc' && env.EFFECTIVE_VERSION || 'OFF' }}
